apiVersion: batch/v1
kind: CronJob
metadata:
  name: calibre-sync-books
spec:
  schedule: "*/5 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers: 
          - name: calibre-sync-books
            image: alpine:latest
            imagePullPolicy: Always
            env:
              - name: GITLAB_TOKEN
                value: "glpat-bJMyn9vnkMsaMZyrAoZs"
              - name: GITLAB_URL
                value: "gitlab-service.gitlab.svc.cluster.local"
            command:
              - /bin/bash
              - -c
              - apk update ; apk add git ; git clone --bare --progress http://oauth2:${GITLAB_TOKEN}@${GITLAB_URL}/gitlab-instance-69044ebd/calibre-web.git /tmp/calibre-web/.git ; chmod +x /tmp/calibre-web/build/scripts/jobs/sync-books.sh ; /tmp/calibre-web/build/scripts/jobs/sync-books.sh
            volumeMounts:
            - name: books
              mountPath: /books
          volumes:
            - name: books
              persistentVolumeClaim:
                claimName: books-pvc
          restartPolicy: Never